generator client {
  provider      = "prisma-client-js"
  output        = "../app/generated/prisma"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                    Int              @id @default(autoincrement())
  firstName             String           @map("first_name") @db.VarChar(100)
  lastName              String           @map("last_name") @db.VarChar(100)
  email                 String           @unique @db.VarChar(255)
  phone                 String?          @db.VarChar(20)
  passwordHash          String?          @map("password_hash") @db.VarChar(255)
  isVerified            Boolean          @default(false) @map("is_verified")
  verificationCode      String?          @map("verification_code") @db.VarChar(10)
  verificationExpiresAt DateTime?        @map("verification_expires_at")
  resetToken            String?          @map("reset_token") @db.VarChar(255)
  resetTokenExpiresAt   DateTime?        @map("reset_token_expires_at")
  googleId              String?          @unique @map("google_id") @db.VarChar(255)
  picture               String?          @map("picture") @db.VarChar(500)
  provider              String?          @default("email") @db.VarChar(50)
  lastLoginAt           DateTime?        @map("last_login_at")
  createdAt             DateTime         @default(now()) @map("created_at")
  updatedAt             DateTime         @updatedAt @map("updated_at")
  ownedBusinesses       Business[]       @relation("BusinessOwner")
  businessMemberships   BusinessUser[]
  addedUsers           BusinessUser[]   @relation("UserAddedBy")
  customers             Customer[]
  grantedPermissions    UserPermission[] @relation("PermissionGrantedBy")
  userPermissions       UserPermission[]
  sessions              UserSession[]
  userPreferences       UserPreference[]
  inventoryMovements    InventoryMovement[]

  @@map("users")
}

model Permission {
  id              Int              @id @default(autoincrement())
  name            String           @unique @db.VarChar(100)
  resource        String           @db.VarChar(100)
  action          String           @db.VarChar(100)
  description     String?
  isActive        Boolean          @default(true) @map("is_active")
  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")
  rolePermissions RolePermission[]
  userPermissions UserPermission[]

  @@unique([resource, action])
  @@map("permissions")
}

model RolePermission {
  id           Int        @id @default(autoincrement())
  role         UserRole
  permissionId Int        @map("permission_id")
  businessId   Int?       @map("business_id")
  isActive     Boolean    @default(true) @map("is_active")
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")
  business     Business?  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([role, permissionId, businessId])
  @@map("role_permissions")
}

model UserPermission {
  id            Int        @id @default(autoincrement())
  userId        Int        @map("user_id")
  permissionId  Int        @map("permission_id")
  businessId    Int?       @map("business_id")
  granted       Boolean    @default(true)
  grantedBy     Int?       @map("granted_by")
  expiresAt     DateTime?  @map("expires_at")
  isActive      Boolean    @default(true) @map("is_active")
  createdAt     DateTime   @default(now()) @map("created_at")
  updatedAt     DateTime   @updatedAt @map("updated_at")
  business      Business?  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  grantedByUser User?      @relation("PermissionGrantedBy", fields: [grantedBy], references: [id])
  permission    Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  user          User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, permissionId, businessId])
  @@map("user_permissions")
}

model UserSession {
  id           String   @id @default(cuid())
  userId       Int      @map("user_id")
  sessionToken String   @unique @map("session_token") @db.VarChar(255)
  deviceInfo   Json?    @map("device_info")
  ipAddress    String?  @map("ip_address") @db.VarChar(45)
  userAgent    String?  @map("user_agent")
  isActive     Boolean  @default(true) @map("is_active")
  lastUsed     DateTime @default(now()) @map("last_used")
  expiresAt    DateTime @map("expires_at")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_sessions")
}

model UserPreference {
  id             Int      @id @default(autoincrement())
  userId         Int      @map("user_id")
  key            String   @db.VarChar(100) // e.g., 'default_business'
  value          String   @db.Text // JSON string for complex values
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, key])
  @@map("user_preferences")
}

model Business {
  id                 Int                 @id @default(autoincrement())
  name               String              @db.VarChar(255)
  businessType       String              @map("business_type") @db.VarChar(100)
  businessCategory   String?             @map("business_category") @db.VarChar(100)
  slug               String              @unique @db.VarChar(100)
  ownerId            Int?                @map("owner_id")
  status             BusinessStatus      @default(PENDING)
  isActive           Boolean             @default(true) @map("is_active")
  createdAt          DateTime            @default(now()) @map("created_at")
  updatedAt          DateTime            @updatedAt @map("updated_at")
  businessSetting    BusinessSetting?
  owner              User?               @relation("BusinessOwner", fields: [ownerId], references: [id])
  employees          BusinessUser[]
  categories         Category[]
  creditApplications CreditApplication[]
  customers          Customer[]
  inventory          Inventory[]
  inventoryMovements InventoryMovement[]
  orders             Order[]
  payments           Payment[]
  products           Product[]
  rolePermissions    RolePermission[]
  userPermissions    UserPermission[]

  @@map("businesses")
}

model BusinessUser {
  id         Int      @id @default(autoincrement())
  businessId Int      @map("business_id")
  userId     Int      @map("user_id")
  role       UserRole
  isActive   Boolean  @default(true) @map("is_active")
  isDeleted  Boolean  @default(false) @map("is_deleted")
  joinedAt   DateTime @default(now()) @map("joined_at")
  addedBy    Int?     @map("added_by")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")
  
  business    Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  addedByUser User?    @relation("UserAddedBy", fields: [addedBy], references: [id])
  
  @@unique([businessId, userId])
  @@map("business_users")
}

model BusinessSetting {
  id                         Int      @id @default(autoincrement())
  businessId                 Int      @unique @map("business_id")
  createdAt                  DateTime @default(now()) @map("created_at")
  updatedAt                  DateTime @updatedAt @map("updated_at")
  address                    String?
  city                       String?  @db.VarChar(100)
  country                    String?  @default("Tanzania") @db.VarChar(100)
  currency                   String   @default("TZS") @db.VarChar(3)
  defaultPaymentMethod       String?  @default("CASH") @map("default_payment_method") @db.VarChar(20)
  description                String?
  email                      String?  @db.VarChar(255)
  enableCreditSales          Boolean? @default(false) @map("enable_credit_sales")
  enableInventoryTracking    Boolean? @default(true) @map("enable_inventory_tracking")
  enableLoyaltyProgram       Boolean? @default(false) @map("enable_loyalty_program")
  enableMultiCurrency        Boolean? @default(false) @map("enable_multi_currency")
  enableMultiLocation        Boolean? @default(false) @map("enable_multi_location")
  enableTaxCalculation       Boolean? @default(true) @map("enable_tax_calculation")
  financialYearStart         String?  @default("01-01") @map("financial_year_start") @db.VarChar(5)
  invoicePrefix              String?  @default("INV") @map("invoice_prefix") @db.VarChar(10)
  language                   String   @default("en") @db.VarChar(2)
  logoUrl                    String?  @map("logo_url") @db.VarChar(500)
  orderPrefix                String?  @default("ORD") @map("order_prefix") @db.VarChar(10)
  phone                      String?  @db.VarChar(20)
  postalCode                 String?  @map("postal_code") @db.VarChar(20)
  primaryColor               String?  @map("primary_color") @db.VarChar(7)
  receiptFooterMessage       String?  @map("receipt_footer_message")
  region                     String?  @db.VarChar(100)
  registrationNumber         String?  @map("registration_number") @db.VarChar(100)
  retailMargin               Decimal? @default(50) @map("retail_margin") @db.Decimal(5, 2)
  secondaryColor             String?  @map("secondary_color") @db.VarChar(7)
  taxRate                    Decimal? @default(18) @map("tax_rate") @db.Decimal(5, 2)
  timezone                   String   @default("Africa/Dar_es_Salaam") @db.VarChar(50)
  website                    String?  @db.VarChar(255)
  wholesaleMargin            Decimal? @default(30) @map("wholesale_margin") @db.Decimal(5, 2)
  feature1Description        String?  @map("feature1_description") @db.VarChar(255)
  feature1DescriptionSwahili String?  @map("feature1_description_swahili") @db.VarChar(255)
  feature1Icon               String?  @map("feature1_icon") @db.VarChar(50)
  feature1Title              String?  @map("feature1_title") @db.VarChar(100)
  feature1TitleSwahili       String?  @map("feature1_title_swahili") @db.VarChar(100)
  feature2Description        String?  @map("feature2_description") @db.VarChar(255)
  feature2DescriptionSwahili String?  @map("feature2_description_swahili") @db.VarChar(255)
  feature2Icon               String?  @map("feature2_icon") @db.VarChar(50)
  feature2Title              String?  @map("feature2_title") @db.VarChar(100)
  feature2TitleSwahili       String?  @map("feature2_title_swahili") @db.VarChar(100)
  feature3Description        String?  @map("feature3_description") @db.VarChar(255)
  feature3DescriptionSwahili String?  @map("feature3_description_swahili") @db.VarChar(255)
  feature3Icon               String?  @map("feature3_icon") @db.VarChar(50)
  feature3Title              String?  @map("feature3_title") @db.VarChar(100)
  feature3TitleSwahili       String?  @map("feature3_title_swahili") @db.VarChar(100)
  feature4Description        String?  @map("feature4_description") @db.VarChar(255)
  feature4DescriptionSwahili String?  @map("feature4_description_swahili") @db.VarChar(255)
  feature4Icon               String?  @map("feature4_icon") @db.VarChar(50)
  feature4Title              String?  @map("feature4_title") @db.VarChar(100)
  feature4TitleSwahili       String?  @map("feature4_title_swahili") @db.VarChar(100)
  businessHours              Json?    @map("business_hours")
  deliveryAreas              Json?    @map("delivery_areas")
  deliveryFee                Decimal? @map("delivery_fee") @db.Decimal(10, 2)
  estimatedDeliveryTime      String?  @map("estimated_delivery_time") @db.VarChar(100)
  freeDeliveryMinimum        Decimal? @map("free_delivery_minimum") @db.Decimal(10, 2)
  paymentMethods             Json?    @map("payment_methods")
  creditTerms                Json?    @map("credit_terms")
  showAboutSection           Boolean? @default(false) @map("show_about_section")
  business                   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@map("business_settings")
}

model Customer {
  id                 Int                 @id @default(autoincrement())
  businessId         Int                 @map("business_id")
  fullName           String              @map("full_name") @db.VarChar(255)
  firstName          String?             @map("first_name") @db.VarChar(100)
  lastName           String?             @map("last_name") @db.VarChar(100)
  email              String?             @db.VarChar(255)
  phone              String              @db.VarChar(20)
  customerType       CustomerType        @default(INDIVIDUAL) @map("customer_type")
  userId             Int?                @map("user_id")
  joinDate           DateTime            @default(now()) @map("join_date")
  notes              String?
  creditLimit        Decimal?            @map("credit_limit") @db.Decimal(10, 2)
  isActive           Boolean             @default(true) @map("is_active")
  createdAt          DateTime            @default(now()) @map("created_at")
  updatedAt          DateTime            @updatedAt @map("updated_at")
  address            String?             @db.VarChar(500)
  dateOfBirth        DateTime?           @map("date_of_birth")
  idNumber           String?             @map("id_number") @db.VarChar(50)
  occupation         String?             @db.VarChar(255)
  creditApplications CreditApplication[]
  business           Business            @relation(fields: [businessId], references: [id])
  user               User?               @relation(fields: [userId], references: [id])
  orders             Order[]
  payments           Payment[]

  @@unique([businessId, phone])
  @@map("customers")
}

model Category {
  id          Int        @id @default(autoincrement())
  businessId  Int        @map("business_id")
  name        String     @db.VarChar(255)
  nameSwahili String?    @map("name_swahili") @db.VarChar(255)
  description String?
  parentId    Int?       @map("parent_id")
  isActive    Boolean    @default(true) @map("is_active")
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")
  business    Business   @relation(fields: [businessId], references: [id], onDelete: Cascade)
  parent      Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryHierarchy")
  products    Product[]

  @@map("categories")
}

model Product {
  id             Int            @id @default(autoincrement())
  businessId     Int            @map("business_id")
  categoryId     Int?           @map("category_id")
  name           String         @db.VarChar(255)
  nameSwahili    String?        @map("name_swahili") @db.VarChar(255)
  description    String?
  sku            String?        @db.VarChar(100)
  barcode        String?        @db.VarChar(100)
  price          Decimal        @db.Decimal(10, 2)
  wholesalePrice Decimal?       @map("wholesale_price") @db.Decimal(10, 2)
  costPrice      Decimal?       @map("cost_price") @db.Decimal(10, 2)
  unit           String?        @db.VarChar(50)
  isActive       Boolean        @default(true) @map("is_active")
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")
  isDraft        Boolean        @default(false) @map("is_draft")
  inventory      Inventory[]
  orderItems     OrderItem[]
  images         ProductImage[]
  movements      InventoryMovement[]
  business       Business       @relation(fields: [businessId], references: [id], onDelete: Cascade)
  category       Category?      @relation(fields: [categoryId], references: [id])

  @@unique([businessId, sku])
  @@map("products")
}

model ProductImage {
  id           Int      @id @default(autoincrement())
  productId    Int      @map("product_id")
  url          String   @db.VarChar(500)
  filename     String   @db.VarChar(255)
  originalName String   @map("original_name") @db.VarChar(255)
  size         Int
  mimeType     String   @map("mime_type") @db.VarChar(100)
  isPrimary    Boolean  @default(false) @map("is_primary")
  sortOrder    Int      @default(0) @map("sort_order")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
  product      Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("product_images")
}

model Inventory {
  id               Int      @id @default(autoincrement())
  businessId       Int      @map("business_id")
  productId        Int      @map("product_id")
  quantity         Int      @default(0)
  reservedQuantity Int      @default(0) @map("reserved_quantity")
  reorderPoint     Int?     @map("reorder_point")
  maxStock         Int?     @map("max_stock")
  location         String   @default("main_store") @db.VarChar(100)
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")
  business         Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  product          Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([businessId, productId, location])
  @@map("inventory")
}

model InventoryMovement {
  id           Int      @id @default(autoincrement())
  businessId   Int      @map("business_id")
  productId    Int      @map("product_id")
  fromLocation String?  @map("from_location") @db.VarChar(100)
  toLocation   String   @map("to_location") @db.VarChar(100)
  quantity     Int
  movementType String   @map("movement_type") @db.VarChar(50) // 'transfer', 'adjustment', 'initial_stock', 'sale'
  reason       String?  @db.VarChar(255)
  referenceId  String?  @map("reference_id") @db.VarChar(100) // Order ID, transfer ID, etc.
  createdBy    Int      @map("created_by")
  createdAt    DateTime @default(now()) @map("created_at")
  
  business     Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  product      Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  user         User     @relation(fields: [createdBy], references: [id])

  @@map("inventory_movements")
}

model Order {
  id                Int                @id @default(autoincrement())
  businessId        Int                @map("business_id")
  customerId        Int                @map("customer_id")
  orderNumber       String             @unique @map("order_number") @db.VarChar(50)
  status            OrderStatus        @default(PENDING)
  orderType         OrderType          @default(RETAIL) @map("order_type")
  subtotal          Decimal            @db.Decimal(10, 2)
  taxAmount         Decimal            @default(0) @map("tax_amount") @db.Decimal(10, 2)
  discountAmount    Decimal            @default(0) @map("discount_amount") @db.Decimal(10, 2)
  totalAmount       Decimal            @map("total_amount") @db.Decimal(10, 2)
  paymentMethod     PaymentMethod      @map("payment_method")
  paymentStatus     PaymentStatus      @default(PENDING) @map("payment_status")
  notes             String?
  deliveryAddress   String?            @map("delivery_address")
  orderDate         DateTime           @default(now()) @map("order_date")
  deliveryDate      DateTime?          @map("delivery_date")
  createdAt         DateTime           @default(now()) @map("created_at")
  updatedAt         DateTime           @updatedAt @map("updated_at")
  paymentPlan       PaymentPlan        @default(FULL) @map("payment_plan")
  creditApplication CreditApplication?
  orderItems        OrderItem[]
  business          Business           @relation(fields: [businessId], references: [id], onDelete: Cascade)
  customer          Customer           @relation(fields: [customerId], references: [id])
  payments          Payment[]

  @@map("orders")
}

model OrderItem {
  id         Int      @id @default(autoincrement())
  orderId    Int      @map("order_id")
  productId  Int      @map("product_id")
  quantity   Int
  unitPrice  Decimal  @map("unit_price") @db.Decimal(10, 2)
  totalPrice Decimal  @map("total_price") @db.Decimal(10, 2)
  createdAt  DateTime @default(now()) @map("created_at")
  order      Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product    Product  @relation(fields: [productId], references: [id])

  @@map("order_items")
}

model Payment {
  id            Int           @id @default(autoincrement())
  businessId    Int           @map("business_id")
  orderId       Int?          @map("order_id")
  customerId    Int           @map("customer_id")
  amount        Decimal       @db.Decimal(10, 2)
  paymentMethod PaymentMethod @map("payment_method")
  paymentStatus PaymentStatus @default(PENDING) @map("payment_status")
  transactionId String?       @map("transaction_id") @db.VarChar(255)
  reference     String?       @db.VarChar(255)
  notes         String?
  paidAt        DateTime?     @map("paid_at")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")
  business      Business      @relation(fields: [businessId], references: [id], onDelete: Cascade)
  customer      Customer      @relation(fields: [customerId], references: [id])
  order         Order?        @relation(fields: [orderId], references: [id])

  @@map("payments")
}

model CreditApplication {
  id                Int          @id @default(autoincrement())
  businessId        Int          @map("business_id")
  customerId        Int          @map("customer_id")
  orderId           Int?         @unique @map("order_id")
  applicationNumber String       @unique @map("application_number") @db.VarChar(50)
  customerType      CustomerType @map("customer_type")
  requestedAmount   Decimal      @map("requested_amount") @db.Decimal(10, 2)
  approvedAmount    Decimal?     @map("approved_amount") @db.Decimal(10, 2)
  interestRate      Decimal      @default(0) @map("interest_rate") @db.Decimal(5, 2)
  termMonths        Int          @map("term_months")
  status            CreditStatus @default(PENDING)
  employmentInfo    Json?        @map("employment_info")
  businessInfo      Json?        @map("business_info")
  guarantorInfo     Json?        @map("guarantor_info")
  creditScore       Int?         @map("credit_score")
  riskLevel         RiskLevel?   @map("risk_level")
  assessmentNotes   String?      @map("assessment_notes")
  applicationDate   DateTime     @default(now()) @map("application_date")
  reviewDate        DateTime?    @map("review_date")
  approvalDate      DateTime?    @map("approval_date")
  disbursementDate  DateTime?    @map("disbursement_date")
  createdAt         DateTime     @default(now()) @map("created_at")
  updatedAt         DateTime     @updatedAt @map("updated_at")
  business          Business     @relation(fields: [businessId], references: [id], onDelete: Cascade)
  customer          Customer     @relation(fields: [customerId], references: [id])
  order             Order?       @relation(fields: [orderId], references: [id])

  @@map("credit_applications")
}

enum UserRole {
  ADMIN
  MANAGER
  CASHIER
  CUSTOMER

  @@map("user_role")
}

enum BusinessStatus {
  PENDING
  ACTIVE
  SUSPENDED
  INACTIVE

  @@map("business_status")
}

enum CustomerType {
  INDIVIDUAL
  BUSINESS

  @@map("customer_type")
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED

  @@map("order_status")
}

enum OrderType {
  RETAIL
  WHOLESALE
  CREDIT

  @@map("order_type")
}

enum PaymentMethod {
  CASH
  CARD
  MOBILE_MONEY
  BANK_TRANSFER
  CREDIT
  PARTIAL

  @@map("payment_method")
}

enum PaymentPlan {
  FULL
  PARTIAL
  CREDIT

  @@map("payment_plan")
}

enum PaymentStatus {
  PENDING
  PAID
  PARTIAL
  FAILED
  REFUNDED

  @@map("payment_status")
}

enum CreditStatus {
  PENDING
  UNDER_REVIEW
  APPROVED
  REJECTED
  DISBURSED
  ACTIVE
  COMPLETED
  DEFAULTED

  @@map("credit_status")
}

enum RiskLevel {
  LOW
  MEDIUM
  HIGH
  VERY_HIGH

  @@map("risk_level")
}
